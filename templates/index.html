<!doctype html>
<html lang="zh-Hant">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>筆記列表</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <header>
        <h1>我的筆記</h1>
        <div class="actions">
        <form id="searchForm" action="{{ url_for('index') }}" method="get">
            <input type="text" name="q" placeholder="搜尋標題..." value="{{ request.args.get('q', '') }}">
            <input type="text" name="tag" placeholder="標籤篩選" value="{{ request.args.get('tag', '') }}">
            <button type="submit" class="btn">搜尋</button>
        </form>
        <a class="btn" href="{{ url_for('new_note') }}">+ 新增筆記 (Ctrl+N)</a>
        <button class="btn" id="export-all-btn">📂 匯出所有筆記</button>
        <button id="importBtn" class="btn">📥 匯入筆記</button>
        <input id="importFile" type="file" accept=".txt,.json,.html" style="display:none">
        </div>
    </header>

    <main>
        {% if notes|length == 0 %}
        <p>目前沒有筆記，按「+ 新增筆記」開始。</p>
        {% else %}
        <ul class="notes">
            {% for n in notes %}
            <li>
                <a class="note-title" href="{{ url_for('edit_note', note_id=n['id']) }}">{{ n['title'] }}</a>
                <div class="meta">更新：{{ n['updated_at'] }}</div>
                <button class="btn danger delete-note-btn" data-id="{{ n['id'] }}">刪除</button>
            </li>
            {% endfor %}
        </ul>
        {% endif %}
    </main>

    <script>
        // ✅ Ctrl+N 快捷鍵：新增筆記
        document.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'n') {
            e.preventDefault();
            window.location.href = '{{ url_for("new_note") }}';
        }
        });

        // ✅ 刪除筆記
        document.querySelectorAll('.delete-note-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
            const noteId = btn.dataset.id;
            if (confirm('確定要刪除此筆記嗎？')) {
            try {
                const res = await fetch(`/note/${noteId}/delete`, { method: 'POST' });
                if (res.ok) {
                btn.closest('li').remove();
                if (document.querySelectorAll('.notes li').length === 0) {
                    location.reload();
                }
                } else {
                alert('刪除失敗');
                }
            } catch (err) {
                alert('刪除錯誤：' + err.message);
            }
            }
        });
        });

        // ✅ 匯出所有筆記（為多個 HTML 檔）
        document.getElementById('export-all-btn').addEventListener('click', async () => {
        try {
            const res = await fetch('/notes/all');
            if (!res.ok) throw new Error('匯出失敗');
            const notes = await res.json();
            if (!notes.length) {
            alert('目前沒有筆記可以匯出。');
            return;
            }

            // 要求使用者選擇資料夾（需 HTTPS 或 localhost）
            const dirHandle = await window.showDirectoryPicker();

            for (const note of notes) {
            const safeTitle = (note.title || '未命名筆記').replace(/[\\/*?:"<>|]/g, '_');
            const fileHandle = await dirHandle.getFileHandle(`${safeTitle}.html`, { create: true });
            const writable = await fileHandle.createWritable();

            const htmlContent = `
    <!DOCTYPE html>
    <html lang="zh-Hant">
    <head>
    <meta charset="UTF-8">
    <title>${note.title}</title>
    </head>
    <body>
    <h1>${note.title}</h1>
    <hr>
    ${note.content}
    </body>
    </html>`;

            await writable.write(htmlContent);
            await writable.close();
            }

            alert('✅ 所有筆記已成功匯出到你選擇的資料夾！');
        } catch (err) {
            console.error(err);
            alert('匯出失敗：' + err.message);
        }
        });

        // ✅ 匯入筆記（支援 .html/.json/.txt）
        const importBtn = document.getElementById('importBtn');
        const importFile = document.getElementById('importFile');
        importBtn.addEventListener('click', () => importFile.click());

        importFile.addEventListener('change', async () => {
        const file = importFile.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = async e => {
            const text = e.target.result;
            let title = file.name.replace(/\.(html|txt|json)$/i, '');
            let content = text;
            let tags = '';

            try {
            if (file.name.endsWith('.json')) {
                const note = JSON.parse(text);
                title = note.title || title;
                content = note.content || text;
                tags = note.tags || '';
            } else if (file.name.endsWith('.html')) {
                const parser = new DOMParser();
                const doc = parser.parseFromString(text, 'text/html');
                doc.querySelectorAll('script').forEach(s => s.remove());

                const body = doc.body || doc;
                // 抓第一個 h1 作為 title
                const h1 = body.querySelector('h1');
                if (h1) {
                    title = h1.textContent.trim();
                    // 選擇是否把 <h1> 移除，保留內容
                    h1.remove();
                }
                content = body.textContent.trim();
            }
            } catch (err) {
            console.warn('解析錯誤，當作純文字處理');
            }

            const formData = new FormData();
            formData.append('title', title);
            formData.append('content', content);
            formData.append('tags', tags);

            const res = await fetch('/note/save', { method: 'POST', body: formData });
            if (res.ok) {
            alert(`已匯入筆記：${title}`);
            location.reload();
            } else {
            alert('匯入失敗');
            }
        };
        reader.readAsText(file);
        });

    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.11.0/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <script>
    document.getElementById('export-all-btn').addEventListener('click', async () => {
    try {
        // 從後端取得所有筆記 JSON
        const res = await fetch('/notes/all'); 
        if (!res.ok) throw new Error('匯出失敗');
        const notes = await res.json();
        if (!notes.length) {
        alert('目前沒有筆記可以匯出。');
        return;
        }

        const zip = new JSZip();
        const folderName = `我的筆記_${new Date().toISOString().split('T')[0]}`; // 例：我的筆記_2025-10-07
        const folder = zip.folder(folderName);

        for (const note of notes) {
        const safeTitle = (note.title || '未命名筆記').replace(/[\\/*?:"<>|]/g, '_');
        const htmlContent = `
    <!DOCTYPE html>
    <html lang="zh-Hant">
    <head>
    <meta charset="UTF-8">
    <title>${note.title}</title>
    </head>
    <body>
    <h1>${note.title}</h1>
    <hr>
    ${note.content}
    </body>
    </html>`;
        folder.file(`${safeTitle}.html`, htmlContent);
        }

        const content = await zip.generateAsync({ type: 'blob' });
        saveAs(content, `${folderName}.zip`);
    } catch (err) {
        console.error(err);
        alert('匯出失敗：' + err.message);
    }
    });
    </script>
</body>
</html>