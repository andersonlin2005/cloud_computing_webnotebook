<!doctype html>
<html lang="zh-Hant">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ç­†è¨˜åˆ—è¡¨</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <header>
        <h1>æˆ‘çš„ç­†è¨˜</h1>
        <div class="actions">
        <form id="searchForm" action="{{ url_for('index') }}" method="get">
            <input type="text" name="q" placeholder="æœå°‹æ¨™é¡Œ..." value="{{ request.args.get('q', '') }}">
            <input type="text" name="tag" placeholder="æ¨™ç±¤ç¯©é¸" value="{{ request.args.get('tag', '') }}">
            <button type="submit" class="btn">æœå°‹</button>
        </form>
        <a class="btn" href="{{ url_for('new_note') }}">+ æ–°å¢ç­†è¨˜ (Ctrl+N)</a>
        <button class="btn" id="export-all-btn">ğŸ“‚ åŒ¯å‡ºæ‰€æœ‰ç­†è¨˜</button>
        <button id="importBtn" class="btn">ğŸ“¥ åŒ¯å…¥ç­†è¨˜</button>
        <input id="importFile" type="file" accept=".txt,.json,.html,.md" style="display:none">
        </div>
    </header>

    <main>
        {% if notes|length == 0 %}
        <p>ç›®å‰æ²’æœ‰ç­†è¨˜ï¼ŒæŒ‰ã€Œ+ æ–°å¢ç­†è¨˜ã€é–‹å§‹ã€‚</p>
        {% else %}
        <ul class="notes">
            {% for n in notes %}
            <li>
                <a class="note-title" href="{{ url_for('edit_note', note_id=n['id']) }}">{{ n['title'] }}</a>
                <div class="meta">æ›´æ–°ï¼š{{ n['updated_at'] }}</div>
                <button class="btn danger delete-note-btn" data-id="{{ n['id'] }}">åˆªé™¤</button>
            </li>
            {% endfor %}
        </ul>
        {% endif %}
    </main>

    <script>
        // âœ… Ctrl+N å¿«æ·éµï¼šæ–°å¢ç­†è¨˜
        document.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'n') {
            e.preventDefault();
            window.location.href = '{{ url_for("new_note") }}';
        }
        });

        // âœ… åˆªé™¤ç­†è¨˜
        document.querySelectorAll('.delete-note-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
            const noteId = btn.dataset.id;
            if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ç­†è¨˜å—ï¼Ÿ')) {
            try {
                const res = await fetch(`/note/${noteId}/delete`, { method: 'POST' });
                if (res.ok) {
                btn.closest('li').remove();
                if (document.querySelectorAll('.notes li').length === 0) {
                    location.reload();
                }
                } else {
                alert('åˆªé™¤å¤±æ•—');
                }
            } catch (err) {
                alert('åˆªé™¤éŒ¯èª¤ï¼š' + err.message);
            }
            }
        });
        });

        // âœ… åŒ¯å‡ºæ‰€æœ‰ç­†è¨˜ï¼ˆæ”¹ç‚ºä¸‹è¼‰ ZIP æª”æ¡ˆï¼‰
        document.getElementById('export-all-btn').addEventListener('click', async () => {
            try {
                const res = await fetch('/notes/all');
                if (!res.ok) throw new Error('åŒ¯å‡ºå¤±æ•—');
                const notes = await res.json();
                if (!notes.length) {
                    alert('ç›®å‰æ²’æœ‰ç­†è¨˜å¯ä»¥åŒ¯å‡ºã€‚');
                    return;
                }

                // æª¢æŸ¥æ˜¯å¦æ”¯æŒç›®éŒ„é¸æ“‡å™¨ API
                if ('showDirectoryPicker' in window) {
                    try {
                        // ä½¿ç”¨ç›®éŒ„é¸æ“‡å™¨ API (è¼ƒæ–°çš„ç€è¦½å™¨)
                        const dirHandle = await window.showDirectoryPicker();
                        
                        for (const note of notes) {
                            const safeTitle = (note.title || 'æœªå‘½åç­†è¨˜').replace(/[\\/*?:"<>|]/g, '_');
                            const fileHandle = await dirHandle.getFileHandle(`${safeTitle}.html`, { create: true });
                            const writable = await fileHandle.createWritable();

                            const htmlContent = `<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>${note.title}</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        h1 { color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        .meta { color: #666; font-size: 0.9em; margin-bottom: 20px; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 5px; overflow-x: auto; }
        code { background: #f5f5f5; padding: 2px 4px; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>${note.title || 'æœªå‘½åç­†è¨˜'}</h1>
    <div class="meta">æ›´æ–°æ™‚é–“ï¼š${note.updated_at}</div>
    <div class="content">${note.content}</div>
</body>
</html>`;

                            await writable.write(htmlContent);
                            await writable.close();
                        }
                        alert('âœ… æ‰€æœ‰ç­†è¨˜å·²æˆåŠŸåŒ¯å‡ºåˆ°ä½ é¸æ“‡çš„è³‡æ–™å¤¾ï¼');
                    } catch (dirErr) {
                        if (dirErr.name === 'AbortError') {
                            return; // ç”¨æˆ¶å–æ¶ˆé¸æ“‡
                        }
                        throw dirErr;
                    }
                } else {
                    // å‚™ç”¨æ–¹æ¡ˆï¼šä¸‹è¼‰å–®ä¸€ JSON æª”æ¡ˆåŒ…å«æ‰€æœ‰ç­†è¨˜
                    const jsonData = JSON.stringify(notes, null, 2);
                    const blob = new Blob([jsonData], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `æ‰€æœ‰ç­†è¨˜_${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    alert('âœ… æ‰€æœ‰ç­†è¨˜å·²åŒ¯å‡ºç‚º JSON æª”æ¡ˆï¼ä½ å¯ä»¥ç¨å¾Œä½¿ç”¨åŒ¯å…¥åŠŸèƒ½æ¢å¾©é€™äº›ç­†è¨˜ã€‚');
                }
            } catch (err) {
                console.error(err);
                alert('åŒ¯å‡ºå¤±æ•—ï¼š' + err.message);
            }
        });

        // âœ… åŒ¯å…¥ç­†è¨˜ï¼ˆæ”¯æ´ .html/.json/.txtï¼‰
        const importBtn = document.getElementById('importBtn');
        const importFile = document.getElementById('importFile');
        importBtn.addEventListener('click', () => importFile.click());

        importFile.addEventListener('change', async () => {
            const file = importFile.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async e => {
                const text = e.target.result;
                let title = file.name.replace(/\.(html|txt|json|md)$/i, '');
                let content = text;
                let tags = '';

                try {
                    if (file.name.endsWith('.json')) {
                        const data = JSON.parse(text);
                        
                        // æª¢æŸ¥æ˜¯å¦ç‚ºæ‰¹é‡åŒ¯å‡ºçš„ JSONï¼ˆé™£åˆ—æ ¼å¼ï¼‰
                        if (Array.isArray(data)) {
                            let importCount = 0;
                            let skipCount = 0;
                            
                            for (const note of data) {
                                const formData = new FormData();
                                formData.append('title', note.title || 'æœªå‘½åç­†è¨˜');
                                formData.append('content', note.content || '');
                                formData.append('tags', note.tags || '');

                                const res = await fetch('/note/save', { method: 'POST', body: formData });
                                if (res.ok) {
                                    importCount++;
                                } else {
                                    skipCount++;
                                }
                            }
                            
                            alert(`æ‰¹é‡åŒ¯å…¥å®Œæˆï¼æˆåŠŸåŒ¯å…¥ ${importCount} ç­†è¨˜éŒ„${skipCount > 0 ? `ï¼Œè·³é ${skipCount} ç­†éŒ„` : ''}ã€‚`);
                            location.reload();
                            return;
                        } else {
                            // å–®ä¸€ç­†è¨˜ JSON
                            title = data.title || title;
                            content = data.content || text;
                            tags = data.tags || '';
                        }
                    } else if (file.name.endsWith('.html')) {
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(text, 'text/html');
                        doc.querySelectorAll('script').forEach(s => s.remove());

                        const body = doc.body || doc;
                        // æŠ“ç¬¬ä¸€å€‹ h1 ä½œç‚º title
                        const h1 = body.querySelector('h1');
                        if (h1) {
                            title = h1.textContent.trim();
                            h1.remove();
                        }
                        content = body.textContent.trim();
                    } else if (file.name.endsWith('.md')) {
                        // è™•ç† Markdown æ–‡ä»¶
                        const lines = text.split('\n');
                        const firstLine = lines[0];
                        if (firstLine.startsWith('# ')) {
                            title = firstLine.substring(2).trim();
                            content = lines.slice(1).join('\n').trim();
                        } else {
                            content = text;
                        }
                    }
                } catch (err) {
                    console.warn('è§£æéŒ¯èª¤ï¼Œç•¶ä½œç´”æ–‡å­—è™•ç†:', err);
                }

                // å–®ä¸€ç­†è¨˜åŒ¯å…¥
                const formData = new FormData();
                formData.append('title', title);
                formData.append('content', content);
                formData.append('tags', tags);

                const res = await fetch('/note/save', { method: 'POST', body: formData });
                if (res.ok) {
                    alert(`å·²åŒ¯å…¥ç­†è¨˜ï¼š${title}`);
                    location.reload();
                } else {
                    alert('åŒ¯å…¥å¤±æ•—');
                }
            };
            reader.readAsText(file);
        });

    </script>
</body>
</html>