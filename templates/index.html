<!doctype html>
<html lang="zh-Hant">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ç­†è¨˜åˆ—è¡¨</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <header>
        <h1>æˆ‘çš„ç­†è¨˜</h1>
        <div class="actions">
        <form id="searchForm" action="{{ url_for('index') }}" method="get">
            <input type="text" name="q" placeholder="æœå°‹æ¨™é¡Œ..." value="{{ request.args.get('q', '') }}">
            <input type="text" name="tag" placeholder="æ¨™ç±¤ç¯©é¸" value="{{ request.args.get('tag', '') }}">
            <button type="submit" class="btn">æœå°‹</button>
        </form>
        <a class="btn" href="{{ url_for('new_note') }}">+ æ–°å¢ç­†è¨˜ (Ctrl+N)</a>
        <button class="btn" id="export-all-btn">ğŸ“‚ åŒ¯å‡ºæ‰€æœ‰ç­†è¨˜</button>
        <button id="importBtn" class="btn">ğŸ“¥ åŒ¯å…¥ç­†è¨˜</button>
        <input id="importFile" type="file" accept=".txt,.json,.html" style="display:none">
        </div>
    </header>

    <main>
        {% if notes|length == 0 %}
        <p>ç›®å‰æ²’æœ‰ç­†è¨˜ï¼ŒæŒ‰ã€Œ+ æ–°å¢ç­†è¨˜ã€é–‹å§‹ã€‚</p>
        {% else %}
        <ul class="notes">
            {% for n in notes %}
            <li>
                <a class="note-title" href="{{ url_for('edit_note', note_id=n['id']) }}">{{ n['title'] }}</a>
                <div class="meta">æ›´æ–°ï¼š{{ n['updated_at'] }}</div>
                <button class="btn danger delete-note-btn" data-id="{{ n['id'] }}">åˆªé™¤</button>
            </li>
            {% endfor %}
        </ul>
        {% endif %}
    </main>

    <script>
        // âœ… Ctrl+N å¿«æ·éµï¼šæ–°å¢ç­†è¨˜
        document.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'n') {
            e.preventDefault();
            window.location.href = '{{ url_for("new_note") }}';
        }
        });

        // âœ… åˆªé™¤ç­†è¨˜
        document.querySelectorAll('.delete-note-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
            const noteId = btn.dataset.id;
            if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ç­†è¨˜å—ï¼Ÿ')) {
            try {
                const res = await fetch(`/note/${noteId}/delete`, { method: 'POST' });
                if (res.ok) {
                btn.closest('li').remove();
                if (document.querySelectorAll('.notes li').length === 0) {
                    location.reload();
                }
                } else {
                alert('åˆªé™¤å¤±æ•—');
                }
            } catch (err) {
                alert('åˆªé™¤éŒ¯èª¤ï¼š' + err.message);
            }
            }
        });
        });

        // âœ… åŒ¯å‡ºæ‰€æœ‰ç­†è¨˜ï¼ˆç‚ºå¤šå€‹ HTML æª”ï¼‰
        document.getElementById('export-all-btn').addEventListener('click', async () => {
        try {
            const res = await fetch('/notes/all');
            if (!res.ok) throw new Error('åŒ¯å‡ºå¤±æ•—');
            const notes = await res.json();
            if (!notes.length) {
            alert('ç›®å‰æ²’æœ‰ç­†è¨˜å¯ä»¥åŒ¯å‡ºã€‚');
            return;
            }

            // è¦æ±‚ä½¿ç”¨è€…é¸æ“‡è³‡æ–™å¤¾ï¼ˆéœ€ HTTPS æˆ– localhostï¼‰
            const dirHandle = await window.showDirectoryPicker();

            for (const note of notes) {
            const safeTitle = (note.title || 'æœªå‘½åç­†è¨˜').replace(/[\\/*?:"<>|]/g, '_');
            const fileHandle = await dirHandle.getFileHandle(`${safeTitle}.html`, { create: true });
            const writable = await fileHandle.createWritable();

            const htmlContent = `
    <!DOCTYPE html>
    <html lang="zh-Hant">
    <head>
    <meta charset="UTF-8">
    <title>${note.title}</title>
    </head>
    <body>
    <h1>${note.title}</h1>
    <hr>
    ${note.content}
    </body>
    </html>`;

            await writable.write(htmlContent);
            await writable.close();
            }

            alert('âœ… æ‰€æœ‰ç­†è¨˜å·²æˆåŠŸåŒ¯å‡ºåˆ°ä½ é¸æ“‡çš„è³‡æ–™å¤¾ï¼');
        } catch (err) {
            console.error(err);
            alert('åŒ¯å‡ºå¤±æ•—ï¼š' + err.message);
        }
        });

        // âœ… åŒ¯å…¥ç­†è¨˜ï¼ˆæ”¯æ´ .html/.json/.txtï¼‰
        const importBtn = document.getElementById('importBtn');
        const importFile = document.getElementById('importFile');
        importBtn.addEventListener('click', () => importFile.click());

        importFile.addEventListener('change', async () => {
        const file = importFile.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = async e => {
            const text = e.target.result;
            let title = file.name.replace(/\.(html|txt|json)$/i, '');
            let content = text;
            let tags = '';

            try {
            if (file.name.endsWith('.json')) {
                const note = JSON.parse(text);
                title = note.title || title;
                content = note.content || text;
                tags = note.tags || '';
            } else if (file.name.endsWith('.html')) {
                const parser = new DOMParser();
                const doc = parser.parseFromString(text, 'text/html');
                doc.querySelectorAll('script').forEach(s => s.remove());

                const body = doc.body || doc;
                // æŠ“ç¬¬ä¸€å€‹ h1 ä½œç‚º title
                const h1 = body.querySelector('h1');
                if (h1) {
                    title = h1.textContent.trim();
                    // é¸æ“‡æ˜¯å¦æŠŠ <h1> ç§»é™¤ï¼Œä¿ç•™å…§å®¹
                    h1.remove();
                }
                content = body.textContent.trim();
            }
            } catch (err) {
            console.warn('è§£æéŒ¯èª¤ï¼Œç•¶ä½œç´”æ–‡å­—è™•ç†');
            }

            const formData = new FormData();
            formData.append('title', title);
            formData.append('content', content);
            formData.append('tags', tags);

            const res = await fetch('/note/save', { method: 'POST', body: formData });
            if (res.ok) {
            alert(`å·²åŒ¯å…¥ç­†è¨˜ï¼š${title}`);
            location.reload();
            } else {
            alert('åŒ¯å…¥å¤±æ•—');
            }
        };
        reader.readAsText(file);
        });

    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.11.0/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <script>
    document.getElementById('export-all-btn').addEventListener('click', async () => {
    try {
        // å¾å¾Œç«¯å–å¾—æ‰€æœ‰ç­†è¨˜ JSON
        const res = await fetch('/notes/all'); 
        if (!res.ok) throw new Error('åŒ¯å‡ºå¤±æ•—');
        const notes = await res.json();
        if (!notes.length) {
        alert('ç›®å‰æ²’æœ‰ç­†è¨˜å¯ä»¥åŒ¯å‡ºã€‚');
        return;
        }

        const zip = new JSZip();
        const folderName = `æˆ‘çš„ç­†è¨˜_${new Date().toISOString().split('T')[0]}`; // ä¾‹ï¼šæˆ‘çš„ç­†è¨˜_2025-10-07
        const folder = zip.folder(folderName);

        for (const note of notes) {
        const safeTitle = (note.title || 'æœªå‘½åç­†è¨˜').replace(/[\\/*?:"<>|]/g, '_');
        const htmlContent = `
    <!DOCTYPE html>
    <html lang="zh-Hant">
    <head>
    <meta charset="UTF-8">
    <title>${note.title}</title>
    </head>
    <body>
    <h1>${note.title}</h1>
    <hr>
    ${note.content}
    </body>
    </html>`;
        folder.file(`${safeTitle}.html`, htmlContent);
        }

        const content = await zip.generateAsync({ type: 'blob' });
        saveAs(content, `${folderName}.zip`);
    } catch (err) {
        console.error(err);
        alert('åŒ¯å‡ºå¤±æ•—ï¼š' + err.message);
    }
    });
    </script>
</body>
</html>