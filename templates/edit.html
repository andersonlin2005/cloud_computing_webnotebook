<!-- templates/edit.html -->
<!doctype html>
<html lang="zh-Hant">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width,initial-scale=1">
        <title>{{ '編輯筆記' if note else '新增筆記' }}</title>
        <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    </head>
    <body>
        <header>
            <h1>{{ '編輯筆記' if note else '新增筆記' }}</h1>
            <div class="shortcuts">
                快捷鍵：`---` 分隔線、`pic` 圖片、`todo` 待辦、`# ` 標題、`>` 引言、``` 程式區塊、`date` 插入日期、Ctrl+S 儲存
            </div>
        </header>
        <main>
            <form id="noteForm" action="{{ url_for('save_note') }}" method="post">
                <input type="hidden" name="id" value="{{ note['id'] if note else '' }}">
                <input type="text" name="title" placeholder="標題" value="{{ note['title'] if note else '' }}">
                <input type="text" name="tags" placeholder="標籤（逗號分隔）" value="{{ note['tags'] if note else '' }}">

                <div class="editor-container">
                    <div class="editor-section">
                        <h3>編輯</h3>
                        <textarea id="editor" name="content" placeholder="在這裡輸入筆記（支援快捷指令）">{{ note['content'] if note else '' }}</textarea>
                    </div>

                    <div class="preview-section">
                        <h3>預覽</h3>
                        <div id="preview" class="preview-area"></div>
                    </div>
                </div> <!-- ✅ 關閉 editor-container -->

                <div class="form-actions">
                    <button type="submit" class="btn">儲存</button>
                    <button id="downloadBtn" type="button" class="btn">下載 HTML</button>
                    <button id="delBtn" type="button" class="btn danger">刪除</button>
                </div>

                <script>
                    const delBtn = document.getElementById('delBtn');

                    delBtn.addEventListener('click', async () => {
                        const idField = document.querySelector('input[name="id"]');
                        const noteId = idField?.value;

                        if (!noteId) {
                            // ✅ 還沒儲存的筆記 → 回到 / 
                            if (confirm('是否確認要放棄該筆記？')) {
                                window.location.href = '/';
                            }
                            return;
                        }

                        // ✅ 已儲存的筆記 → 刪除後回首頁
                        if (confirm('確定要刪除此筆記嗎？')) {
                            const res = await fetch(`/note/${noteId}/delete`, { method: 'POST' });
                            if (res.ok) {
                                alert('筆記已刪除');
                                window.location.href = '/';
                            } else {
                                alert('刪除失敗');
                            }
                        }
                    });
                </script>
            </form>

            <input id="imageInput" type="file" accept="image/*" style="display:none">
        </main>


        <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
        <script src="{{ url_for('static', filename='app.js') }}"></script>
        <script>
            const uploadUrl = "{{ url_for('upload_image') }}";
            window.APP_INIT = { uploadUrl };
        </script>
    </body>
</html>
<script src="https://cdn.jsdelivr.net/npm/@yaireo/tagify@4.17.0/dist/tagify.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@yaireo/tagify@4.17.0/dist/tagify.css">
<script>
    const tagsInput = document.querySelector('input[name="tags"]');
    fetch('/tags')
        .then(res => res.json())
        .then(tags => {
            new Tagify(tagsInput, {
                whitelist: tags,
                maxTags: 10,
                dropdown: { maxItems: 20, enabled: 0 }
            });
        });
</script>
<!-- Add KaTeX and highlight.js -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/core.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/languages/javascript.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/languages/python.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/lib/marked.min.js"></script>
<script src="{{ url_for('static', filename='app.js') }}"></script>